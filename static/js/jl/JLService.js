var TAG="JLCardInfoServer";var JLObuWechat33Request=require("./JLObuWechat33Request");var JLCmdTool=require("./JLCmdTool");var JLBleManager=require("./JLBleManager");var config=require("./JLZJConfig");var JLObuWechat33Reveice=require("./JLObuWechat33Reveice");var code=require("./errorCode");var service=require("./JLServiceTool");var dataTool=require("./dataTool");var len_hex="";var file_cmd="";export function getCardholderInfo(callback1,callback2){service.ICCReset(res1=>{callback1.call(this,res1)},res2=>{if(res2.code==code.successCode()){service.selectTheDirectory(0,res3=>{callback1.call(this,res3)},res4=>{if(res4.code==code.successCode()){cardInfo_Read0016File(res5=>{callback1.call(this,res5)},res6=>{callback2.call(this,res6)})}else{callback2.call(this,res4)}})}else{callback2.call(this,res2)}})};function cardInfo_Read0016File(callback1,callback2){console.log(TAG+"cardInfo_Read0016File--------读卡信息文件");var cmd=JLCmdTool.JL_ICC_File0016();var cmd_arr=JLObuWechat33Request.ICCChannelTransmission("00",[cmd]);JLBleManager.sendCommand(cmd_arr,res=>{if(res.code==code.successCode()){callback1.call(this,{fireFlag:config.ICCFile0016()});JLObuWechat33Reveice.receive0016File(res=>{callback2.call(this,res)})}else{callback2.call(this,res)}})}export function getCardInfo(callback1,callback2){service.ICCReset(res1=>{callback1.call(this,res1)},res2=>{if(res2.code==code.successCode()){service.selectTheDirectory(1,res3=>{callback1.call(this,res3)},res4=>{if(res4.code==code.successCode()){cardInfo_Read0015File(res5=>{callback1.call(this,res5)},res6=>{callback2.call(this,res6)})}else{callback2.call(this,res4)}})}else{callback2.call(this,res2)}})};function cardInfo_Read0015File(callback1,callback2){console.log(TAG+"cardInfo_Read0015File--------读卡信息文件");var cmd=JLCmdTool.JL_ICC_File0015();var cmd_arr=JLObuWechat33Request.ICCChannelTransmission("00",[cmd]);JLBleManager.sendCommand(cmd_arr,res=>{if(res.code==code.successCode()){callback1.call(this,{fireFlag:config.ICCFile0015()});JLObuWechat33Reveice.receive0015File(res=>{if(res.code!=code.successCode()){res.err_msg="读取卡信息失败";callback2.call(this,res)}else{callback2.call(this,res)}})}else{callback2.call(this,res)}})}export function creditForLoadInit(pincode,keyIndex,terminalNom,money,callback1,callback2){service.ICCReset(res_reset1=>{callback1.call(this,res_reset1)},res_reset2=>{if(res_reset2.code==code.successCode()){service.selectTheDirectory(1,res_menu1=>{callback1.call(this,res_menu1)},res_menu2=>{if(res_menu2.code==code.successCode()){creditForLoad_checkPIN(pincode,res_pin1=>{callback1.call(this,res_pin1)},res_pin2=>{if(res_pin2.code==code.successCode()){creditForLoad_init(keyIndex,terminalNom,money,res_init1=>{callback1.call(this,res_init1)},res_init2=>{callback2.call(this,res_init2)})}else{callback2.call(this,res_pin2)}})}else{callback2.call(this,res_menu2)}})}else{callback2.call(this,res_reset2)}})};export function creditForLoad(time,mac2,callback1,callback2){creditForLoad_Load(time,mac2,res_load1=>{callback1.call(this,res_load1)},res_load2=>{callback2.call(this,res_load2)})};function creditForLoad_checkPIN(pincode,callback1,callback2){console.log(TAG+"checkPIN--------验PIN:"+pincode);var cmd=JLCmdTool.JL_ICCC_PIN(pincode);var cmd_arr=JLObuWechat33Request.ICCChannelTransmission("00",[cmd]);JLBleManager.sendCommand(cmd_arr,res=>{if(res.code==code.successCode()){callback1.call(this,{fireFlag:config.ICCPIN()});JLObuWechat33Reveice.recevieCheckPIN(res=>{if(res.code!=code.successCode()){res.err_msg="验证PIN码失败";callback2.call(this,res)}else{callback2.call(this,res)}})}else{callback2.call(this,res)}})}function creditForLoad_init(keyIndex,terminalNo,money,callback1,callback2){console.log(TAG+"creditForLoad_init--------圈存初始化:"+keyIndex+":"+terminalNo+":"+money);money=dataTool.tenToHex(parseInt(money),8);var cmd=JLCmdTool.JL_ICC_CreditInit(keyIndex,terminalNo,money);var cmd_arr=JLObuWechat33Request.ICCChannelTransmission("00",[cmd]);JLBleManager.sendCommand(cmd_arr,res=>{if(res.code==code.successCode()){callback1.call(this,{fireFlag:config.ICCInitForLoad()});JLObuWechat33Reveice.recevieCreditForInit(res=>{if(res.code!=code.successCode()){res.err_msg="圈存初始化失败";callback2.call(this,res)}else{callback2.call(this,res)}})}else{callback2.call(this,res)}})}function creditForLoad_Load(time,mac2,callback1,callback2){console.log(TAG+"creditForLoad_Load--------圈存写卡:"+time+","+mac2);var cmd=JLCmdTool.JL_ICC_CreditForLoad(time,mac2);var cmd_arr=JLObuWechat33Request.ICCChannelTransmission("00",[cmd]);JLBleManager.sendCommand(cmd_arr,res=>{if(res.code==code.successCode()){callback1.call(this,{fireFlag:config.ICCCreditForLoad()});JLObuWechat33Reveice.recevieCreditForLoad(res=>{if(res.code!=code.successCode()){res.err_msg="圈存写卡失败";callback2.call(this,res)}else{callback2.call(this,res)}})}else{callback2.call(this,res)}})}export function getCarInfo(random,callback1,callback2){console.log(TAG+"getCarInfo--------读车辆信息  random"+random);service.ESAMReset(res1=>{callback1.call(this,res1)},res2=>{if(res2.code==code.successCode()){service.selectTheDirectory(3,res3=>{callback1.call(this,res3)},res4=>{carInfo_getrand(res5=>{callback1.call(this,res5)},res6=>{if(random.length==0||random==null||random=="undefined"){random=res6.data}carInfo_ReadCarFile(random,res7=>{callback1.call(this,res7)},res8=>{callback2.call(this,res8)})})})}else{callback2.call(this,res2)}})};function carInfo_getrand(callback1,callback2){console.log(TAG+"carInfo_getrand--------获取随机数");var cmd=JLCmdTool.JL_ESAM_Random("08");var cmd_arr=JLObuWechat33Request.ESAMChannelTransmission("00",[cmd]);JLBleManager.sendCommand(cmd_arr,res=>{if(res.code==code.successCode()){callback1.call(this,{fireFlag:config.ESAMRandom()});JLObuWechat33Reveice.receiveObuRandom(res=>{if(res.code!=code.successCode()){res.err_msg="获取车辆信息随机数失败";callback2.call(this,res)}else{callback2.call(this,res)}})}else{callback2.call(this,res)}})}function carInfo_ReadCarFile(random,callback1,callback2){console.log(TAG+"carInfo_ReadCarFile--------读车辆信息文件");var cmd=[];cmd[0]=JLCmdTool.JL_ESAM_FileCar(random,"3B");var cmd_arr=JLObuWechat33Request.ESAMChannelTransmission("00",cmd);JLBleManager.sendCommand(cmd_arr,res=>{if(res.code==code.successCode()){callback1.call(this,{fireFlag:config.ReadCarInfo()});JLObuWechat33Reveice.receiveCarInfo(res=>{if(res.code!=code.successCode()){res.err_msg="读取车辆信息失败";callback2.call(this,res)}else{callback2.call(this,res)}})}else{callback2.call(this,res)}})}export function readRetainFile(fileName,len,callback1,callback2){var data_bin=dataTool.hexTobin(fileName);var file_name=dataTool.binTohex(dealFileName(data_bin));len_hex=dataTool.tenToHex(len);file_cmd=JLCmdTool.JL_ICC_RetainFile(file_name,len_hex);service.ICCReset(res1=>{callback1.call(this,res1)},res2=>{if(res2.code==code.successCode()){service.selectTheDirectory(1,res3=>{callback1.call(this,res3)},res4=>{if(res4.code==code.successCode()){retainFile_ReadRetainFile(res5=>{callback1.call(this,res5)},res6=>{callback2.call(this,res6)})}else{callback2.call(this,res4)}})}else{callback2.call(this,res2)}})};function retainFile_ReadRetainFile(callback1,callback2){console.log(TAG+"retainFile_ReadRetainFile--------读保留文件");var cmd=JLCmdTool.JL_ICC_RetainFile(file_cmd,len_hex);var cmd_arr=JLObuWechat33Request.ICCChannelTransmission("00",[cmd]);JLBleManager.sendCommand(cmd_arr,res=>{if(res.code==code.successCode()){callback1.call(this,{fireFlag:config.ICCReadRetainFile()});JLObuWechat33Reveice.receive0015File(res=>{if(res.code!=code.successCode()){res.err_msg="读取保留文件信息失败";callback2.call(this,res)}else{callback2.call(this,res)}})}else{callback2.call(this,res)}})}function dealFileName(data){var fileFlag=data.substr(data.length-5,5);fileFlag="100"+fileFlag;return fileFlag}export function getSystemInfo(callback1,callback2){service.ESAMReset(res1=>{callback1.call(this,res1)},res2=>{if(res2.code==code.successCode()){service.selectTheDirectory(2,res3=>{callback1.call(this,res3)},res4=>{if(res4.code==code.successCode()){systemInfo_ReadSystemInfoFile(res5=>{callback1.call(this,res5)},res6=>{callback2.call(this,res6)})}else{callback2.call(this,res4)}})}else{callback2.call(this,res2)}})};function systemInfo_ReadSystemInfoFile(callback1,callback2){console.log(TAG+"systemInfo_ReadSystemInfoFile--------读系统信息文件");var cmd=JLCmdTool.JL_ESAM_FileSystem("00","1B");var cmd_arr=JLObuWechat33Request.ESAMChannelTransmission("00",[cmd]);JLBleManager.sendCommand(cmd_arr,res=>{if(res.code==code.successCode()){callback1.call(this,{fireFlag:config.ReadSystemInfo()});JLObuWechat33Reveice.receiveSystemInfo(res=>{if(res.code!=code.successCode()){res.err_msg="读取Obu系统信息失败";callback2.call(this,res)}else{callback2.call(this,res)}})}else{callback2.call(this,res)}})}export function cardInfo_WriteCardInfoFile(strInfo,callback1,callback2){console.log(TAG+"systemInfo_WriteObuInfoFile--------写卡信息");console.log(TAG+"cmd--------写卡信息文件"+strInfo);var cmd_arr=JLObuWechat33Request.ICCChannelTransmission("00",strInfo);JLBleManager.sendCommand(cmd_arr,res=>{if(res.code==code.successCode()){callback1.call(this,{fireFlag:config.WriteCardInfo()});JLObuWechat33Reveice.receiveWriteCardInfo(res=>{if(res.code!=code.successCode()){res.err_msg="写卡信息失败";callback2.call(this,res)}else{callback2.call(this,res)}})}else{callback2.call(this,res)}})};export function systemInfo_WriteObuInfoFile(strInfo,callback1,callback2){console.log(TAG+"systemInfo_WriteObuInfoFile--------写系统信息文件或车辆信息文件");console.log(TAG+"cmd--------写系统信息文件或车辆信息文件指令"+strInfo);var cmd_arr=JLObuWechat33Request.ESAMChannelTransmission("00",strInfo);JLBleManager.sendCommand(cmd_arr,res=>{if(res.code==code.successCode()){callback1.call(this,{fireFlag:config.WriteObuInfo()});JLObuWechat33Reveice.receiveWriteObuInfo(res=>{if(res.code!=code.successCode()){res.err_msg="写Obu系统信息失败";callback2.call(this,res)}else{callback2.call(this,res)}})}else{callback2.call(this,res)}})};export function getObuRandom(type,callback1,callback2){console.log(TAG+"getObuRandom--------获取随机数");if(parseInt(type)==0||parseInt(type)==1){service.ESAMReset(res1=>{callback1.call(this,res1)},res2=>{if(res2.code==code.successCode()){if(type===0){service.selectTheDirectory(2,res3=>{callback1.call(this,res3)},res4=>{if(res4.code==code.successCode()){systemInfo_ReadRandom(res5=>{callback1.call(this,res5)},res6=>{callback2.call(this,res6)})}else{callback2.call(this,res4)}})}else{service.selectTheDirectory(3,res3=>{callback1.call(this,res3)},res4=>{if(res4.code==code.successCode()){systemInfo_ReadRandom(res5=>{callback1.call(this,res5)},res6=>{callback2.call(this,res6)})}else{callback2.call(this,res4)}})}}else{callback2.call(this,res2)}})}else{callback2.call(this,{code:Code.errorCode(),msg:"",data:""});return}};function systemInfo_ReadRandom(callback1,callback2){console.log(TAG+"systemInfo_ReadRandom--------读随机数");var cmd=[];cmd[0]=JLCmdTool.JL_ESAM_Random("04");var cmd_arr=JLObuWechat33Request.ESAMChannelTransmission("00",cmd);JLBleManager.sendCommand(cmd_arr,res=>{if(res.code==code.successCode()){callback1.call(this,{fireFlag:config.ESAMRandom()});JLObuWechat33Reveice.receiveObuRandom(res=>{if(res.code!=code.successCode()){res.err_msg="获取系统信息随机数失败";callback2.call(this,res)}else{callback2.call(this,res)}})}else{callback2.call(this,res)}})}export function getCardRandom(type,len,callback1,callback2){console.log(TAG+"getCardRandom--------获取随机数");if(parseInt(type)==0||parseInt(type)==1){service.ICCReset(res1=>{callback1.call(this,res1)},res2=>{if(res2.code==code.successCode()){if(type===0){service.selectTheDirectory(1,res3=>{callback1.call(this,res3)},res4=>{if(res4.code==code.successCode()){cardInfo_ReadRandom(len,res5=>{callback1.call(this,res5)},res6=>{callback2.call(this,res6)})}else{callback2.call(this,res4)}})}else{service.selectTheDirectory(0,res3=>{callback1.call(this,res3)},res4=>{if(res4.code==code.successCode()){cardInfo_ReadRandom(len,res5=>{callback1.call(this,res5)},res6=>{callback2.call(this,res6)})}else{callback2.call(this,res4)}})}}else{callback2.call(this,res2)}})}else{callback2.call(this,{code:Code.errorCode(),msg:"请填写正确type",data:""});return}};function cardInfo_ReadRandom(len,callback1,callback2){console.log(TAG+"cardInfo_ReadRandom--------读随机数");var cmd=[];cmd[0]=JLCmdTool.JL_ICC_Rand(len);var cmd_arr=JLObuWechat33Request.ICCChannelTransmission("00",cmd);JLBleManager.sendCommand(cmd_arr,res=>{if(res.code==code.successCode()){callback1.call(this,{fireFlag:config.ICCRandom()});JLObuWechat33Reveice.receiveCardRandom(res=>{if(res.code!=code.successCode()){res.err_msg="获取卡片信息随机数失败";callback2.call(this,res)}else{callback2.call(this,res)}})}else{callback2.call(this,res)}})}