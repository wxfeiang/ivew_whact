var dataTool=require("./dataTool");var wechat=require("./JLWechatProtocol");var frame=0;var MAX_PACK_LEN=95;var ST="33";export function packData(cmd){var cmd_arr=pack33Protocol(cmd);var wechat_arr=wechat.packWechatCmd(cmd_arr);var cmdArray=[];for(var i=0;i<wechat_arr.length;i++){var wechat_cmd=wechat_arr[i].wxTotalData;if(wechat_cmd.length<40){cmdArray.push(wechat_cmd)}else{for(var j=0;j<wechat_cmd.length;j+=40){var wechat_sub_cmd=wechat_cmd.substr(j,40);cmdArray.push(wechat_sub_cmd)}}}return cmdArray};function pack33Protocol(cmd){add_Frame();var cmdlen=cmd.length/2;var cmd33conten=[];if(cmdlen>MAX_PACK_LEN){var packages=Math.round(cmdlen/MAX_PACK_LEN);for(var i=0;i<packages;i++){var tempBean={ST:"",SN:"",CTL:"",LEN:"",DATA:"",BCC:"",TOTALDATA:""};tempBean.ST=ST;tempBean.SN=dataTool.tenToHex(frame,2);if(i==0){tempBean.CTL=get_ctl(1,packages-(i+1))}else{tempBean.CTL=get_ctl(0,packages-(i+1))}if(i+1==packages){tempBean.DATA=cmd.substring(i*MAX_PACK_LEN*2)}else{tempBean.DATA=cmd.substring(i*MAX_PACK_LEN*2,i*MAX_PACK_LEN*2+MAX_PACK_LEN*2)}tempBean.LEN=dataTool.tenToHex(tempBean.DATA.length/2,2);tempBean.BCC=dataTool.bccCheck(tempBean.SN+tempBean.CTL+tempBean.LEN+tempBean.DATA);console.log("tempBean.BCC====================:"+tempBean.BCC);tempBean.TOTALDATA=tempBean.ST+tempBean.SN+tempBean.CTL+tempBean.LEN+tempBean.DATA+tempBean.BCC;cmd33conten.push(tempBean)}}else{var tempBean={ST:"",SN:"",CTL:"",LEN:"",DATA:"",BCC:"",TOTALDATA:""};tempBean.ST=ST;tempBean.SN=dataTool.tenToHex(frame,2);tempBean.CTL=get_ctl(1,0);tempBean.LEN=dataTool.tenToHex(cmdlen,2);tempBean.DATA=cmd;tempBean.BCC=dataTool.bccCheck(tempBean.SN+tempBean.CTL+tempBean.LEN+tempBean.DATA);tempBean.TOTALDATA=tempBean.ST+tempBean.SN+tempBean.CTL+tempBean.LEN+tempBean.DATA+tempBean.BCC;cmd33conten.push(tempBean)}return cmd33conten}export function cread_apdu(cmdArr){var content=cread_TLV(cmdArr);var contentuLen=content.length/2;var contentApdu="";var contentApduLen="";if(contentuLen<=80){contentApduLen=dataTool.tenToHex(contentuLen,2)}else{if(contentuLen<=255){contentApduLen="81"+dataTool.tenToHex(contentuLen,2)}else{contentApduLen="82"+dataTool.tenToHex(contentuLen,4)}}contentApdu="80"+contentApduLen+content;return contentApdu};function cread_TLV(cmdArr){var strTLV="";for(var i=1;i<=cmdArr.length;i++){var cmd=cmdArr[i-1];var len=cmd.length/2;strTLV=strTLV+dataTool.tenToHex(i,2)+dataTool.tenToHex(len,2)+cmd}return strTLV}function add_Frame(){frame++;if(frame>15){frame=0}}function get_ctl(bit7,serial){var ctl="";if(bit7==0){ctl=dataTool.tenToHex(serial,2)}else{var n=(2<<6)+serial;ctl=dataTool.tenToHex(n,2)}return ctl}